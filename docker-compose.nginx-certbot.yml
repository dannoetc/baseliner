# Optional: Nginx + Let's Encrypt (certbot) for TLS (FIXED bootstrap)
#
# Problem this solves:
# - nginx cannot start if it references LE cert paths that don't exist yet
# - certbot cannot obtain a cert if nginx isn't serving the HTTP-01 challenge on port 80
#
# Fix:
# - nginx always starts using an internal *bootstrap* self-signed cert stored in /etc/nginx/certs
# - once certbot obtains a real LE cert at /etc/letsencrypt/live/$BASELINER_DOMAIN/..., nginx re-renders config and reloads
#
# Required env vars:
#   BASELINER_DOMAIN=api.example.com
#   CERTBOT_EMAIL=you@example.com
#
# Bring up:
#   BASELINER_DOMAIN=api.example.com CERTBOT_EMAIL=you@example.com \
#     docker compose -f docker-compose.yml -f docker-compose.nginx-certbot.yml up -d --build
#
services:
  api:
    ports: []
    command: ["bash", "-lc", "alembic upgrade head && uvicorn baseliner_server.main:app --reload --proxy-headers --forwarded-allow-ips='*' --host 0.0.0.0 --port 8000"]

  nginx:
    build:
      context: .
      dockerfile: deploy/nginx/Dockerfile
    container_name: baseliner-nginx
    depends_on:
      - api
    environment:
      BASELINER_DOMAIN: ${BASELINER_DOMAIN}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/templates:/etc/nginx/templates:ro
      - ./deploy/nginx/docker-entrypoint.d:/docker-entrypoint.d:ro
      - certbot_webroot:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    container_name: baseliner-certbot
    depends_on:
      - nginx
    environment:
      BASELINER_DOMAIN: ${BASELINER_DOMAIN}
      CERTBOT_EMAIL: ${CERTBOT_EMAIL}
    volumes:
      - certbot_webroot:/var/www/certbot
      - letsencrypt:/etc/letsencrypt
    entrypoint: ["/bin/sh", "-lc"]
    command: >
      set -euo pipefail;
      : "${BASELINER_DOMAIN:?BASELINER_DOMAIN is required}";
      : "${CERTBOT_EMAIL:?CERTBOT_EMAIL is required}";
      echo "[INFO] Ensuring initial cert exists for ${BASELINER_DOMAIN}";
      certbot certonly --webroot -w /var/www/certbot
        -d "${BASELINER_DOMAIN}"
        --email "${CERTBOT_EMAIL}"
        --agree-tos
        --no-eff-email
        --non-interactive
        || true;
      echo "[INFO] Starting renewal loop";
      while :; do
        certbot renew --webroot -w /var/www/certbot --quiet || true;
        sleep 12h;
      done

volumes:
  letsencrypt:
  certbot_webroot:
